services:

  mariadb:
    container_name: mariadb
    build:
      context: requirements/mariadb
      dockerfile: Dockerfile
    env_file: .env
    secrets:
    - sql_root_password
    - sql_user_password
    - sql_admin_password
    volumes:
    - mariadb:/var/lib/mysql
    networks:
    - inception
    restart: unless-stopped
    healthcheck:
     test: ["CMD", "mariadb-admin ping", "-h", "localhost", "-u", "$$SQL_USER", "-p$$SQL_USER_PASSWORD"]
     interval: 30s
     timeout: 5s
     retries: 3
     start_period: 10s

  wordpress:
    container_name: wordpress
    build:
      context: requirements/wordpress
      dockerfile: Dockerfile
    env_file: .env
    secrets:
    - wp_admin_password
    - wp_user_password
    - sql_user_password
    volumes:
    - wordpress:/var/www/wordpress
    networks:
    - inception
    depends_on:
    - mariadb
    - redis
    restart: unless-stopped

  nginx:
    container_name: nginx
    build:
      context: requirements/nginx
      dockerfile: Dockerfile
    env_file: .env
    volumes:
    - wordpress:/var/www/wordpress
    networks:
    - inception
    depends_on:
    - wordpress
    - adminer
    ports:
    - "443:443"
    # restart after crash
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-fk", "https://localhost/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
  
  redis:
    container_name: redis
    build:
      context: requirements/bonus/redis
      dockerfile: Dockerfile
    env_file: .env
    networks:
    - inception
    restart: unless-stopped

  adminer:
    container_name: adminer
    build:
      context: requirements/bonus/adminer
      dockerfile: Dockerfile
    env_file: .env
    networks:
    - inception
    depends_on:
    - mariadb
    restart: unless-stopped

volumes:
  wordpress:
    name: wordpress
    driver: local
    driver_opts:
      type: 'none'
      o: 'bind'
      device: '${DATA_DIR}/wordpress'
  mariadb:
    name: mariadb
    driver: local
    driver_opts:
      type: 'none'
      o: 'bind'
      device: '${DATA_DIR}/mariadb'

networks:
  inception:
    name: inception
    driver: bridge

secrets:
  wp_admin_password:
    file: ../secrets/wp_admin_password.txt
  wp_user_password:
    file: ../secrets/wp_user_password.txt
  sql_admin_password:
    file: ../secrets/sql_admin_password.txt
  sql_user_password:
    file: ../secrets/sql_user_password.txt
  sql_root_password:
    file: ../secrets/sql_root_password.txt
